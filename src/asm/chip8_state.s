global MEMORY
global REGISTERS
global STACK
global CH8_SP
global PC
global KEYPAD
global REG_I
global DELAY_TIMER
global SOUND_TIMER
global DISPLAY
global init_chip8

section .bss
	MEMORY: resb 0x1000
	REGISTERS: resb 0x10
	STACK: resw 0x10
	CH8_SP: resb 0x1
	PC: resw 0x1
	KEYPAD: resb 0x10
	REG_I: resw 0x1
	DELAY_TIMER: resb 0x1
	SOUND_TIMER: resb 0x1
	DISPLAY: resb 256

section .data
	FONTSET:
		db 0xF0, 0x90, 0x90, 0x90, 0xF0
		db 0x20, 0x60, 0x20, 0x20, 0x70
		db 0xF0, 0x10, 0xF0, 0x80, 0xF0
		db 0xF0, 0x10, 0xF0, 0x10, 0xF0
		db 0x90, 0x90, 0xF0, 0x10, 0x10
		db 0xF0, 0x80, 0xF0, 0x10, 0xF0
		db 0xF0, 0x80, 0xF0, 0x90, 0xF0
		db 0xF0, 0x10, 0x20, 0x40, 0x40
		db 0xF0, 0x90, 0xF0, 0x90, 0xF0
		db 0xF0, 0x90, 0xF0, 0x10, 0xF0
		db 0xF0, 0x90, 0xF0, 0x90, 0x90
		db 0xE0, 0x90, 0xE0, 0x90, 0xE0
		db 0xF0, 0x80, 0x80, 0x80, 0xF0
		db 0xE0, 0x90, 0x90, 0x90, 0xE0
		db 0xF0, 0x80, 0xF0, 0x80, 0xF0
		db 0xF0, 0x80, 0xF0, 0x80, 0x80

section .text

init_chip8:
	push rbp
	mov rbp, rsp

	mov ax, 0x0200
	mov [rel PC], ax
	xor eax, eax
	mov byte [rel CH8_SP], al
	xor ax, ax
	mov [rel REG_I], ax

	xor rax, rax
	mov rcx, 0x10
	lea rdi, [rel REGISTERS]
	rep stosb

	xor rax, rax
	mov rcx, 0x1000
	lea rdi, [rel MEMORY]
	rep stosb

	lea rsi, [rel FONTSET]
	lea rdi, [rel MEMORY]
	mov rcx, 0x50
	rep movsb

	xor rax, rax
	mov rcx, 0x100
	lea rdi, [rel DISPLAY]
	rep stosb
	
	xor rax, rax
	mov rcx, 0x10
	lea rdi, [rel KEYPAD]
	rep stosb

	xor eax, eax
	mov byte [rel DELAY_TIMER], al
	mov byte [rel SOUND_TIMER], al

	leave
	ret
